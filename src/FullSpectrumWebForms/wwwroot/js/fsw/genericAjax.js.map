{"version":3,"file":"genericAjax.js","sourceRoot":"","sources":["genericAjax.ts"],"names":[],"mappings":"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","sourcesContent":["namespace gen {\r\n\r\n    function __handleAjaxCommunicationError(options: JQueryAjaxSettings) {\r\n        const divID = '__ajaxCommErrorDiv';\r\n        if (!document.getElementById(divID))// not init yet\r\n        {\r\n            var ajaxCommErrorDiv = $('<div id=\"' + divID + '\" data-role=\"dialog\" data-overlay=\"true\" data-width=\"25rem\" data-height=\"200px\" data-close-button=\"false\" data-overlay-color=\"#222222\" ></div>');\r\n            ajaxCommErrorDiv.append($('<h1 class=\"text-light\"> Connection perdu </h1>'));\r\n            ajaxCommErrorDiv.append($('<hr class=\"thin bg-orange\"/>'));\r\n\r\n            ajaxCommErrorDiv.append(\"<div>Une erreur est survenus lors de la connection au serveur.</div>\");\r\n            ajaxCommErrorDiv.append(\"<div>Reconnection en cours, veuillez patientez...</div>\");\r\n            ajaxCommErrorDiv.append(\"<br/>\");\r\n            ajaxCommErrorDiv.append(\"<br/>\");\r\n            ajaxCommErrorDiv.append(\"<div>Si le problème persiste, contactez votre administrateur réseau</div>\");\r\n\r\n            ajaxCommErrorDiv.appendTo('body');\r\n        }\r\n        setTimeout(function () {\r\n            $('#' + divID).data('dialog').open();\r\n\r\n            var previousSuccessFunction = options.success as any;\r\n\r\n            options.success = function (data: any, textStatus: string, jqXHR: JQueryXHR) {\r\n                $('#' + divID).data('dialog').close();\r\n                previousSuccessFunction(data, textStatus, jqXHR);\r\n            }\r\n\r\n            setTimeout(function () {\r\n                $.ajax(options);\r\n            }, 5000);\r\n        }, 10);\r\n    }\r\n    export function modSQL(storedProcedureName: string, parameters: any): JQueryDeferred<any> {\r\n        return gen.ajax({\r\n            url: \"/GenServices.asmx/ModSQL\",\r\n            data: {\r\n                method: storedProcedureName,\r\n                param: parameters\r\n            }\r\n        });\r\n    }\r\n    var _alreadyInFastLoginMode = false; // true if an ajax called return 'not login' and the user as not entered it's login info yet ( 17/01/2017, PAR )\r\n    // you need to configure 'success' and 'data' and 'url'\r\n    export function ajax(options: JQueryAjaxSettings, doNotParseToJson?: boolean): JQueryDeferred<any> {\r\n        options = $.extend({\r\n            data: {},\r\n            contentType: \"application/json; charset=utf-8\",\r\n            type: \"POST\",\r\n            dataType: \"json\",\r\n        }, options);\r\n\r\n        if (typeof options.data != \"string\" && !doNotParseToJson)\r\n            options.data = JSON.stringify(options.data);\r\n\r\n        var callbacksOptions: {\r\n            complete?(jqXHR: JQueryXHR, textStatus: string): any;\r\n            success?(data: any, textStatus: string, jqXHR: JQueryXHR): any\r\n        } = {};\r\n        // remove all callbacks from the options\r\n        if (options.complete) {\r\n            callbacksOptions.complete = options.complete as any;\r\n            delete options.complete;\r\n        }\r\n        callbacksOptions.success = options.success as any;\r\n\r\n        var deferred = $.Deferred<any>();\r\n        var error = options.error as any;\r\n        options.error = function (xhr, ajaxOptions, thrownError) {\r\n            if (xhr.readyState == 0) {\r\n                // Network error (i.e. connection refused, access denied due to CORS, etc.)\r\n                __handleAjaxCommunicationError(options);\r\n            }\r\n            else if (xhr.status == 500 && xhr.responseJSON && xhr.responseJSON.Message == \"NO_ACCESS\") {\r\n                if (_alreadyInFastLoginMode) { // if an other ajax call is already showing the login form ( 17/01/2017, PAR )\r\n                    var handle = setInterval(function () {// wait 'till the login is completed by the other ajax call, and then finish this current ajax call\r\n                        if (!_alreadyInFastLoginMode) {\r\n                            clearInterval(handle);\r\n                            $.ajax(options);\r\n                        }\r\n                    }, 500);\r\n                }\r\n                else { // it's the first ajax call that got an NO_ACCESS message\r\n                    _alreadyInFastLoginMode = true;\r\n                    var iFrame = $('<iframe src=\"/Login.aspx\" width=\"100%\" height=\"100%\" style=\"position:absolute;top:0px;left:0px;z-index:99999\"></iframe>');\r\n                    var counter = 0;\r\n                    iFrame.on('load', function () {\r\n                        if (counter) { // login completed\r\n                            iFrame.remove();\r\n                            _alreadyInFastLoginMode = false;\r\n                            $.ajax(options);\r\n                        }\r\n                        ++counter;\r\n                    });\r\n                    $('body').append(iFrame);\r\n                }\r\n            }\r\n            else if (error) {\r\n                error(xhr, ajaxOptions, thrownError);\r\n                if (callbacksOptions.complete)\r\n                    callbacksOptions.complete(xhr, xhr.statusText);\r\n                deferred.reject(xhr);\r\n            }\r\n            else {\r\n                alert(xhr.responseText);\r\n                if (callbacksOptions.complete)\r\n                    callbacksOptions.complete(xhr, xhr.statusText);\r\n                deferred.reject(xhr);\r\n            }\r\n        };\r\n        options.success = function (data: any, textStatus: string, jqXHR: JQueryXHR) {\r\n            if (callbacksOptions.success)\r\n                callbacksOptions.success(data, textStatus, jqXHR);\r\n            if (callbacksOptions.complete)\r\n                callbacksOptions.complete(jqXHR, jqXHR.statusText);\r\n            deferred.resolve(data);\r\n        }\r\n\r\n        $.ajax(options);\r\n\r\n        return deferred;\r\n    }\r\n    export function ajax_sync(options: JQueryAjaxSettings): JQueryDeferred<any> {\r\n        options.async = false;\r\n        return this.ajax(options);\r\n    }\r\n}\r\nvar gen_ajax = gen;"]}